#!/bin/bash

# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!

WORKDIR={{backup_work}}/{{item.name}}

{% if item.source.startswith('postgresql://') %}

DBNAME={{item.source.split('postgresql://')[-1]}}
psql {{ ('-U %s' % backup_postgres_user) if backup_postgres_user else '' }} {{ ('-h %s' % backup_postgres_host) if backup_postgres_host else ''}} {{ ('-p %s' % backup_postgres_port) if backup_postgres_port else ''}} $DBNAME < $WORKDIR/dump
rm -rf $WORKDIR/dump

{% elif item.source.startswith('mysql://') %}

{% if item.source == 'mysql://' %}
# Restore all databases
mysql {{ '-u %s' % backup_mysql_user if backup_mysql_user else '' }} {{ '-p%s' % (backup_mysql_pass|quote) if backup_mysql_pass else '' }} < ${WORKDIR}/dump
{% else %}
# Restore the passed database
DBNAME={{item.source.split('mysql://')[-1]}}
mysql {{ '-u %s' % backup_mysql_user if backup_mysql_user else '' }} {{ '-p%s' % (backup_mysql_pass|quote) if backup_mysql_pass else '' }} $DBNAME  < ${WORKDIR}/dump
rm -rf $WORKDIR/dump
{% endif %}

{% elif item.source.startswith('mongo://') %}

mongorestore --drop $WORKDIR/dump
rm -rf $WORKDIR/dump

{% endif %}

{% for action in item.restore_actions|default([]) %}
{{ action }}
{% endfor %}
